name: Application Deployment

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/application.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-2

concurrency:
  group: application-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      auth-api: ${{ steps.changes.outputs.auth-api }}
      todos-api: ${{ steps.changes.outputs.todos-api }}
      users-api: ${{ steps.changes.outputs.users-api }}
      log-processor: ${{ steps.changes.outputs.log-processor }}
      compose: ${{ steps.changes.outputs.compose }}
      deploy-needed: ${{ steps.check.outputs.deploy-needed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            auth-api:
              - 'auth-api/**'
            todos-api:
              - 'todos-api/**'
            users-api:
              - 'users-api/**'
            log-processor:
              - 'log-message-processor/**'
            compose:
              - 'docker-compose.yml'
              - '.env'

      - name: Check if deployment needed
        id: check
        run: |
          if [ "${{ steps.changes.outputs.frontend }}" == "true" ] || \
             [ "${{ steps.changes.outputs.auth-api }}" == "true" ] || \
             [ "${{ steps.changes.outputs.todos-api }}" == "true" ] || \
             [ "${{ steps.changes.outputs.users-api }}" == "true" ] || \
             [ "${{ steps.changes.outputs.log-processor }}" == "true" ] || \
             [ "${{ steps.changes.outputs.compose }}" == "true" ]; then
            echo "deploy-needed=true" >> $GITHUB_OUTPUT
            echo "Changes detected - deployment needed"
          else
            echo "deploy-needed=false" >> $GITHUB_OUTPUT
            echo "No application changes detected - skipping deployment"
          fi

  build-and-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy-needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and test services
        run: |
          echo "Building changed services..."
          
          # Build only changed services to save time
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
            echo "Building frontend..."
            docker build -t test-frontend ./frontend
          fi
          
          if [ "${{ needs.detect-changes.outputs.auth-api }}" == "true" ]; then
            echo "Building auth-api..."
            docker build -t test-auth-api ./auth-api
          fi
          
          if [ "${{ needs.detect-changes.outputs.todos-api }}" == "true" ]; then
            echo "Building todos-api..."
            docker build -t test-todos-api ./todos-api
          fi
          
          if [ "${{ needs.detect-changes.outputs.users-api }}" == "true" ]; then
            echo "Building users-api..."
            docker build -t test-users-api ./users-api
          fi
          
          if [ "${{ needs.detect-changes.outputs.log-processor }}" == "true" ]; then
            echo "Building log-message-processor..."
            docker build -t test-log-processor ./log-message-processor
          fi

      - name: Test docker-compose configuration
        run: |
          # Create a test .env file
          cat > .env << EOF
          DOMAIN=localhost
          ACME_EMAIL=test@example.com
          COMPOSE_PROJECT_NAME=test
          PORT=8080
          AUTH_API_ADDRESS=http://auth-api:8081
          TODOS_API_ADDRESS=http://todos-api:8082
          AUTH_API_PORT=8081
          JWT_SECRET=testsecret
          USERS_API_ADDRESS=http://users-api:8083
          REDIS_HOST=redis-queue
          REDIS_PORT=6379
          REDIS_CHANNEL=log_channel
          SERVER_PORT=8083
          ZIPKIN_URL=http://zipkin:9411/api/v2/spans
          EOF
          
          # Validate docker-compose configuration
          docker compose config --quiet
          echo "Docker Compose configuration is valid"

  deploy:
    needs: [detect-changes, build-and-test]
    if: needs.detect-changes.outputs.deploy-needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
          terraform_wrapper: false

      - name: Get server IP from infrastructure
        id: server
        run: |
          # Check if infrastructure workflow has run and get IP from artifacts or API
          # For now, try terraform state, if empty, suggest running infrastructure first
          cd infra/terraform
          terraform init -input=false
          
          # Check if state has any resources
          if ! terraform state list 2>/dev/null | grep -q "aws_instance"; then
            echo "No EC2 instance found in terraform state."
            echo "Please run the infrastructure pipeline first to create the server."
            exit 1
          fi
          
          # Get server IP
          SERVER_IP=$(terraform output -raw instance_ip 2>/dev/null || terraform output -raw public_ip 2>/dev/null || echo "")
          
          if [ -n "$SERVER_IP" ] && [ "$SERVER_IP" != "null" ]; then
            echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
            echo "Found server IP: $SERVER_IP"
          else
            echo "Server exists but no IP output found. This shouldn't happen."
            terraform state show aws_instance.app_server | grep public_ip || echo "No public IP in state"
            exit 1
          fi

      - name: Create SSH key file
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./ssh-key.pem
          chmod 600 ./ssh-key.pem

      - name: Install Ansible
        run: |
          pip install ansible-core==2.17.5
          ansible-galaxy collection install community.docker

      - name: Create Ansible inventory
        run: |
          mkdir -p infra/ansible
          cat > infra/ansible/inventory << EOF
          [app_servers]
          ${{ steps.server.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=../../ssh-key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          
          [app_servers:vars]
          domain=${{ vars.DOMAIN }}
          email=${{ vars.EMAIL_ALERT }}
          duckdns_token=${{ secrets.DUCKDNS_TOKEN }}
          github_repo=${{ github.server_url }}/${{ github.repository }}.git
          github_branch=${{ github.ref_name }}
          EOF

      - name: Deploy application
        run: |
          cd infra/ansible
          ansible-playbook -i inventory playbook.yml -v --tags deploy
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Verify deployment
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          # Test if the application is responding
          for i in {1..10}; do
            if curl -f -s --max-time 10 "http://${{ steps.server.outputs.server_ip }}:8080" > /dev/null; then
              echo "Application is responding on port 8080"
              break
            fi
            echo "Attempt $i/10: Application not ready yet, waiting..."
            sleep 10
          done

      - name: Send deployment notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'üöÄ Application Deployment Complete'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">üöÄ Application Deployment Successful</h2>
                
                <div style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #c3e6cb;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Deployment Type:</strong> Application Update</p>
                  <p><strong>Server IP:</strong> ${{ steps.server.outputs.server_ip }}</p>
                  <p><strong>Domain:</strong> <a href="https://${{ vars.DOMAIN }}">https://${{ vars.DOMAIN }}</a></p>
                </div>
                
                <h3 style="color: #0366d6;">Services Updated:</h3>
                <ul>
                  <li>${{ needs.detect-changes.outputs.frontend == 'true' && '‚úÖ Frontend (Vue.js)' || '‚è≠Ô∏è Frontend (no changes)' }}</li>
                  <li>${{ needs.detect-changes.outputs.auth-api == 'true' && '‚úÖ Auth API (Go)' || '‚è≠Ô∏è Auth API (no changes)' }}</li>
                  <li>${{ needs.detect-changes.outputs.todos-api == 'true' && '‚úÖ Todos API (Node.js)' || '‚è≠Ô∏è Todos API (no changes)' }}</li>
                  <li>${{ needs.detect-changes.outputs.users-api == 'true' && '‚úÖ Users API (Java)' || '‚è≠Ô∏è Users API (no changes)' }}</li>
                  <li>${{ needs.detect-changes.outputs.log-processor == 'true' && '‚úÖ Log Processor (Python)' || '‚è≠Ô∏è Log Processor (no changes)' }}</li>
                  <li>${{ needs.detect-changes.outputs.compose == 'true' && '‚úÖ Docker Compose Configuration' || '‚è≠Ô∏è Docker Compose (no changes)' }}</li>
                </ul>
                
                <h3 style="color: #0366d6;">Application URLs:</h3>
                <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px;">
                  <p>üåê <strong>Frontend:</strong> <a href="https://${{ vars.DOMAIN }}">https://${{ vars.DOMAIN }}</a></p>
                  <p>üîê <strong>Auth API:</strong> <a href="https://${{ vars.DOMAIN }}/api/auth">https://${{ vars.DOMAIN }}/api/auth</a></p>
                  <p>üìù <strong>Todos API:</strong> <a href="https://${{ vars.DOMAIN }}/api/todos">https://${{ vars.DOMAIN }}/api/todos</a></p>
                  <p>üë• <strong>Users API:</strong> <a href="https://${{ vars.DOMAIN }}/api/users">https://${{ vars.DOMAIN }}/api/users</a></p>
                </div>
                
                <h3 style="color: #0366d6;">Test Credentials:</h3>
                <ul>
                  <li><strong>Username:</strong> admin | <strong>Password:</strong> Admin123</li>
                  <li><strong>Username:</strong> hng | <strong>Password:</strong> HngTech</li>
                  <li><strong>Username:</strong> user | <strong>Password:</strong> Password</li>
                </ul>
                
                <h3 style="color: #0366d6;">Post-Deployment Checklist:</h3>
                <ul>
                  <li>Test login functionality</li>
                  <li>Verify API endpoints</li>
                  <li>Check SSL certificate</li>
                  <li>Monitor application logs</li>
                </ul>
                
                <div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #d4edda; border-radius: 5px;">
                  <p style="font-size: 18px; font-weight: bold; color: #155724;">Deployment completed successfully! üéâ</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>Automated deployment notification</em><br>
                  <em>Commit: ${{ github.sha }}</em>
                </p>
              </div>
            </body>
            </html>

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ùå Application Deployment Failed'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #d73a49; border-bottom: 2px solid #d73a49; padding-bottom: 10px;">‚ùå Application Deployment Failed</h2>
                
                <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #f5c6cb;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Status:</strong> Deployment failed</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_id }}</p>
                  <p><strong>Server IP:</strong> ${{ steps.server.outputs.server_ip || 'Not available' }}</p>
                </div>
                
                <h3 style="color: #d73a49;">Failure Details:</h3>
                <p>The application deployment pipeline has failed. Please check the workflow logs for detailed error information.</p>
                
                <h3 style="color: #0366d6;">Troubleshooting Steps:</h3>
                <ol>
                  <li>Check the <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">workflow logs</a></li>
                  <li>Verify server connectivity and SSH access</li>
                  <li>Check Ansible playbook syntax and configuration</li>
                  <li>Verify Docker services are running properly</li>
                  <li>Check application logs on the server</li>
                </ol>
                
                <h3 style="color: #0366d6;">Common Issues:</h3>
                <ul>
                  <li>Server connectivity problems</li>
                  <li>Docker build or startup failures</li>
                  <li>Configuration file errors</li>
                  <li>Resource constraints on server</li>
                  <li>Network or firewall issues</li>
                </ul>
                
                <div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f8d7da; border-radius: 5px;">
                  <p style="font-size: 18px; font-weight: bold; color: #721c24;">Please investigate and retry the deployment.</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>Automated failure notification</em><br>
                  <em>Commit: ${{ github.sha }}</em>
                </p>
              </div>
            </body>
            </html>

  no-changes:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy-needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No deployment needed
        run: |
          echo "No application changes detected. Skipping deployment."
          echo "Changed paths in this push do not affect the application services."
          
      - name: Send no-changes notification
        if: github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ÑπÔ∏è Application Pipeline - No Changes Detected'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #0366d6; border-bottom: 2px solid #0366d6; padding-bottom: 10px;">‚ÑπÔ∏è Application Pipeline Executed - No Changes</h2>
                
                <div style="background-color: #e1f5fe; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #b3e5fc;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Trigger:</strong> Manual workflow dispatch</p>
                  <p><strong>Result:</strong> No deployment needed</p>
                </div>
                
                <h3 style="color: #0366d6;">Analysis:</h3>
                <p>The application deployment pipeline was triggered but no changes were detected in:</p>
                <ul>
                  <li>Frontend service</li>
                  <li>Auth API service</li>
                  <li>Todos API service</li>
                  <li>Users API service</li>
                  <li>Log Message Processor service</li>
                  <li>Docker Compose configuration</li>
                </ul>
                
                <h3 style="color: #0366d6;">Current Status:</h3>
                <p>Your application is running the latest deployed version.</p>
                
                <h3 style="color: #0366d6;">If you expected changes:</h3>
                <ul>
                  <li>Verify your changes are in the correct directories</li>
                  <li>Check that files were committed and pushed</li>
                  <li>Ensure the workflow paths are configured correctly</li>
                </ul>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>Automated pipeline notification</em>
                </p>
              </div>
            </body>
            </html>