name: Infra pipeline

on:
  push:
    branches: [main]
    paths: ['infra/terraform/**','infra/ansible/**','.github/workflows/infra.yml']
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VAR_email_ses: ${{ secrets.EMAIL_ALERT }}
  DOMAIN: ${{ secrets.DOMAIN }}
  DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}   # NEW

# prevent two pushes from fighting
concurrency:
  group: infra-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      drift: ${{ steps.plan.outputs.drift }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8          # pinned

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: terraform init
        run: terraform -chdir=infra/terraform init -input=false

      - name: terraform plan
        id: plan
        run: |
          set +e
          terraform -chdir=infra/terraform plan -detailed-exitcode -out=tfplan
          EXIT_CODE=$?
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -eq 2 ]; then echo "drift=true" >> $GITHUB_OUTPUT; else echo "drift=false" >> $GITHUB_OUTPUT; fi
          exit 0   # keep step green so mail can run

      - name: upload plan artefact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/tfplan
          retention-days: 7

      - name: send drift e-mail
        if: steps.plan.outputs.drift == 'true'
        uses: cinotify/email-action@v1.0.0
        with:
          to: ${{ secrets.EMAIL_ALERT }}
          subject: 'DRIFT DETECTED â€“ terraform plan needs approval'
          body: |
            A terraform plan found changes. Visit ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} to approve.

      - name: hold for manual approval
        if: steps.plan.outputs.drift == 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.repository_owner }}
          minimum-approvals: 1

      - name: terraform apply
        run: terraform -chdir=infra/terraform apply -input=false tfplan

      - name: install ansible
        run: |
          pip install ansible-core==2.17.5
          ansible-galaxy install -r infra/ansible/requirements.yml

      - name: generate inventory
        run: ./infra/scripts/gen_inventory.sh > infra/ansible/inventory.ini
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          EMAIL:  ${{ secrets.EMAIL_ALERT }}
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_BRANCH: ${{ github.ref_name }}

      - name: run ansible
        run: ansible-playbook -i infra/ansible/inventory.ini infra/ansible/playbook.yml