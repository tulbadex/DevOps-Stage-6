name: Infrastructure Pipeline

on:
  push:
    branches: [main]
    paths: 
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-2
  TF_VAR_aws_region: us-east-2
  TF_VAR_ami_id: ami-0cb91c7de36eed2cb
  TF_VAR_instance_type: t3.medium
  TF_VAR_instance_name: hng-stage6-web-server
  TF_VAR_ssh_key_name: ${{ secrets.SSH_KEY_NAME }}
  TF_VAR_private_key_path: ../../ssh-key.pem
  TF_VAR_github_repo: ${{ github.server_url }}/${{ github.repository }}.git
  TF_VAR_github_branch: ${{ github.ref_name }}
  TF_VAR_email: ${{ vars.EMAIL_ALERT }}
  TF_VAR_domain: ${{ vars.DOMAIN }}
  TF_VAR_email_ses: ${{ vars.EMAIL_ALERT }}
  TF_VAR_duckdns_token: ${{ secrets.DUCKDNS_TOKEN }}

concurrency:
  group: infrastructure-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      drift: ${{ steps.plan.outputs.drift }}
      server_ip: ${{ steps.apply.outputs.server_ip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create SSH key file
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./ssh-key.pem
          chmod 600 ./ssh-key.pem

      - name: Create S3 bucket first (without backend)
        run: |
          cd infra/terraform
          # Temporarily rename backend.tf to disable S3 backend
          mv backend.tf backend.tf.disabled
          # Initialize without backend
          terraform init -input=false
          
          # Try to import existing bucket first
          terraform import aws_s3_bucket.terraform_state hng13-stage6-terraform-state || echo "Bucket doesn't exist, will create"
          
          # Apply to create/configure S3 bucket
          terraform apply -target=aws_s3_bucket.terraform_state -target=aws_s3_bucket_versioning.terraform_state -target=aws_s3_bucket_server_side_encryption_configuration.terraform_state -auto-approve

      - name: Configure S3 backend
        run: |
          cd infra/terraform
          # Restore backend configuration
          mv backend.tf.disabled backend.tf
          
      - name: Terraform Init with S3 backend
        run: |
          cd infra/terraform
          terraform init -force-copy -input=false

      - name: Terraform Plan (Drift Detection)
        id: plan
        run: |
          set +e
          terraform -chdir=infra/terraform plan -detailed-exitcode -out=tfplan -no-color > plan_output.txt 2>&1
          EXIT_CODE=$?
          
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "drift=false" >> $GITHUB_OUTPUT
            echo "No changes detected - infrastructure is up to date"
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "drift=error" >> $GITHUB_OUTPUT
            echo "Terraform plan failed with errors"
            cat plan_output.txt
            exit 1
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "drift=true" >> $GITHUB_OUTPUT
            echo "Infrastructure drift detected - changes planned"
          fi
          
          # Add plan output to job summary
          echo "## Terraform Plan Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Terraform Plan
        if: steps.plan.outputs.drift == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_number }}
          path: |
            infra/terraform/tfplan
            plan_output.txt
          retention-days: 30

      - name: Send Drift Detection Email
        if: steps.plan.outputs.drift == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'üö® INFRASTRUCTURE DRIFT DETECTED - Manual Approval Required'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #d73a49; border-bottom: 2px solid #d73a49; padding-bottom: 10px;">üö® Infrastructure Drift Alert</h2>
                
                <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Repository:</strong> ${{ github.repository }}</p>
                  <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_id }}</p>
                </div>
                
                <h3 style="color: #0366d6;">Summary</h3>
                <p>Infrastructure drift has been detected. The current infrastructure state differs from your Terraform configuration.</p>
                
                <h3 style="color: #0366d6;">What This Means</h3>
                <ul>
                  <li>Resources may have been modified outside of Terraform</li>
                  <li>New resources may need to be created</li>
                  <li>Existing resources may need updates</li>
                  <li>Manual approval is required before applying changes</li>
                </ul>
                
                <h3 style="color: #0366d6;">Required Actions</h3>
                <ol>
                  <li><strong>Review the changes</strong> in the GitHub Actions workflow</li>
                  <li><strong>Download the Terraform plan</strong> from the artifacts</li>
                  <li><strong>Approve or reject</strong> the changes</li>
                  <li><strong>Investigate</strong> why drift occurred to prevent future issues</li>
                </ol>
                
                <h3 style="color: #0366d6;">Links</h3>
                <p>
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                     style="background-color: #0366d6; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px 0;">
                    View Workflow Run
                  </a><br>
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts" 
                     style="background-color: #28a745; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px 0;">
                    Download Terraform Plan
                  </a>
                </p>
                
                <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0;">
                  <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Security Note</h3>
                  <p>If you did not expect these changes, this could indicate:</p>
                  <ul>
                    <li>Unauthorized access to your AWS account</li>
                    <li>Manual changes made outside of the CI/CD process</li>
                    <li>Configuration drift that needs immediate attention</li>
                  </ul>
                </div>
                
                <div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
                  <p style="font-size: 18px; font-weight: bold; color: #d73a49;">Please review and approve/reject within 24 hours.</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>This is an automated message from your DevOps pipeline.</em><br>
                  <em>Generated at: ${{ github.event.head_commit.timestamp }}</em>
                </p>
              </div>
            </body>
            </html>

      - name: Wait for Manual Approval
        if: steps.plan.outputs.drift == 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.repository_owner }}
          minimum-approvals: 1
          polling-interval-seconds: 60
          issue-title: 'üö® Infrastructure Drift - Manual Approval Required'
          issue-body: |
            ## Infrastructure Drift Detected - Approval Required
            
            **Workflow:** ${{ github.workflow }}
            **Run ID:** ${{ github.run_id }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            
            ### Changes Detected
            Terraform has detected changes that need to be applied to your infrastructure.
            
            ### Review Process
            1. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Download and review the Terraform plan from artifacts
            3. Verify the changes are expected and safe
            
            ### Approval
            - **To approve:** Comment `approved` on this issue
            - **To reject:** Comment `denied` on this issue
            
            ### Security Reminder
            Only approve if you understand and expect these changes.
            
            **This issue will auto-close if no action is taken.**

      - name: Terraform Apply
        id: apply
        if: steps.plan.outputs.drift == 'true' || steps.plan.outputs.drift == 'false'
        run: |
          if [ "${{ steps.plan.outputs.drift }}" == "true" ]; then
            echo "Applying planned changes..."
            terraform -chdir=infra/terraform apply -input=false tfplan
          else
            echo "No changes to apply - infrastructure is up to date"
          fi
          
          # Get server IP for inventory
          SERVER_IP=$(terraform -chdir=infra/terraform output -raw instance_ip 2>/dev/null || echo "")
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          
          if [ -n "$SERVER_IP" ]; then
            echo "Server IP: $SERVER_IP"
          else
            echo "Warning: Could not retrieve server IP"
          fi

      - name: Generate Ansible Inventory
        if: steps.apply.outputs.server_ip != ''
        run: |
          mkdir -p infra/ansible
          cat > infra/ansible/inventory << EOF
          [app_servers]
          ${{ steps.apply.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=../../ssh-key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          
          [app_servers:vars]
          domain=${{ vars.DOMAIN }}
          email=${{ vars.EMAIL_ALERT }}
          duckdns_token=${{ secrets.DUCKDNS_TOKEN }}
          github_repo=${{ github.server_url }}/${{ github.repository }}.git
          github_branch=${{ github.ref_name }}
          EOF

      - name: Install Ansible
        if: steps.apply.outputs.server_ip != ''
        run: |
          pip install ansible-core==2.17.5
          ansible-galaxy collection install community.docker

      - name: Wait for SSH to be ready
        if: steps.apply.outputs.server_ip != ''
        run: |
          echo "Waiting for SSH to be ready on ${{ steps.apply.outputs.server_ip }}..."
          for i in {1..30}; do
            if ssh -i ./ssh-key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${{ steps.apply.outputs.server_ip }} echo "SSH Ready"; then
              echo "SSH is ready!"
              break
            fi
            echo "Attempt $i/30 failed, waiting 10 seconds..."
            sleep 10
          done

      - name: Run Ansible Deployment
        if: steps.apply.outputs.server_ip != ''
        run: |
          cd infra/ansible
          ansible-playbook -i inventory playbook.yml -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Send Success Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚úÖ Infrastructure Deployment Successful'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">‚úÖ Infrastructure Deployment Complete</h2>
                
                <div style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #c3e6cb;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Status:</strong> Successfully deployed</p>
                  <p><strong>Server IP:</strong> ${{ steps.apply.outputs.server_ip }}</p>
                  <p><strong>Domain:</strong> <a href="https://${{ vars.DOMAIN }}">https://${{ vars.DOMAIN }}</a></p>
                </div>
                
                <h3 style="color: #0366d6;">What was deployed:</h3>
                <ul>
                  <li>Infrastructure provisioned with Terraform</li>
                  <li>Server configured with Ansible</li>
                  <li>Application deployed with Docker Compose</li>
                  <li>SSL certificates configured</li>
                  <li>Traefik reverse proxy setup</li>
                </ul>
                
                <h3 style="color: #0366d6;">Access your application:</h3>
                <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px;">
                  <p>üåê <strong>Frontend:</strong> <a href="https://${{ vars.DOMAIN }}">https://${{ vars.DOMAIN }}</a></p>
                  <p>üîê <strong>Auth API:</strong> <a href="https://${{ vars.DOMAIN }}/api/auth">https://${{ vars.DOMAIN }}/api/auth</a></p>
                  <p>üìù <strong>Todos API:</strong> <a href="https://${{ vars.DOMAIN }}/api/todos">https://${{ vars.DOMAIN }}/api/todos</a></p>
                  <p>üë• <strong>Users API:</strong> <a href="https://${{ vars.DOMAIN }}/api/users">https://${{ vars.DOMAIN }}/api/users</a></p>
                </div>
                
                <h3 style="color: #0366d6;">Next Steps:</h3>
                <ul>
                  <li>Test your application functionality</li>
                  <li>Monitor for any issues</li>
                  <li>Check logs if needed: <code>docker logs &lt;container_name&gt;</code></li>
                </ul>
                
                <div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #d4edda; border-radius: 5px;">
                  <p style="font-size: 18px; font-weight: bold; color: #155724;">Deployment completed successfully! üéâ</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>Automated deployment notification</em>
                </p>
              </div>
            </body>
            </html>

      - name: Send Failure Notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ vars.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ùå Infrastructure Deployment Failed'
          to: ${{ vars.EMAIL_ALERT }}
          from: 'DevOps Pipeline <${{ vars.SMTP_USERNAME }}>'
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #d73a49; border-bottom: 2px solid #d73a49; padding-bottom: 10px;">‚ùå Infrastructure Deployment Failed</h2>
                
                <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #f5c6cb;">
                  <p><strong>Project:</strong> HNG13 Stage 6 DevOps</p>
                  <p><strong>Status:</strong> Deployment failed</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_id }}</p>
                </div>
                
                <h3 style="color: #d73a49;">Failure Details:</h3>
                <p>The infrastructure deployment pipeline has failed. Please check the workflow logs for detailed error information.</p>
                
                <h3 style="color: #0366d6;">Troubleshooting Steps:</h3>
                <ol>
                  <li>Check the <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">workflow logs</a></li>
                  <li>Verify AWS credentials and permissions</li>
                  <li>Check Terraform configuration syntax</li>
                  <li>Verify Ansible playbook syntax</li>
                  <li>Ensure all required secrets are configured</li>
                </ol>
                
                <h3 style="color: #0366d6;">Common Issues:</h3>
                <ul>
                  <li>AWS credential problems</li>
                  <li>Resource limits or quotas</li>
                  <li>Network connectivity issues</li>
                  <li>Configuration syntax errors</li>
                </ul>
                
                <div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f8d7da; border-radius: 5px;">
                  <p style="font-size: 18px; font-weight: bold; color: #721c24;">Please investigate and retry the deployment.</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 30px 0;">
                <p style="font-size: 12px; color: #6a737d; text-align: center;">
                  <em>Automated failure notification</em>
                </p>
              </div>
            </body>
            </html>