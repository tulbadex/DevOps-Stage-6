---
# Deploy the application

- name: Clone the repository
  become: true
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes

- name: Create letsencrypt directory
  become: true
  file:
    path: /home/ubuntu/todoapp/letsencrypt
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Set correct permissions for acme.json
  become: true
  file:
    path: /home/ubuntu/todoapp/letsencrypt/acme.json
    state: touch
    mode: '0600'

- name: setup ssl cert
  become: true
  shell: |
    curl "https://www.duckdns.org/update?domains={{ domain }}&token={{ duckdns_token }}&ip={{ ansible_host }}"

- name: Copy environment file
  template:
    src: ../../templates/.env.j2
    dest: "/home/ubuntu/todoapp/.env"
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Create docker network
  become: true
  shell: |
    docker network inspect app-network >/dev/null 2>&1 || docker network create app-network
  args:
    executable: /bin/bash


- name: Start application with Docker Compose
  become: true
  shell: |
    cd /home/ubuntu/todoapp && docker compose up -d
  args:
    executable: /bin/bash