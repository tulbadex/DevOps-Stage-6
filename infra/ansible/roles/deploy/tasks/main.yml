---
# Deploy the application

- name: Check if repository exists
  stat:
    path: /home/ubuntu/todoapp/.git
  register: git_repo
  tags: [deploy]

- name: Clone repository if not exists
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes
  become_user: ubuntu
  when: not git_repo.stat.exists
  tags: [deploy]

- name: Pull latest changes from repository
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes
    update: yes
  become_user: ubuntu
  register: git_pull
  when: git_repo.stat.exists
  tags: [deploy]

- name: Force git pull to ensure latest changes
  shell: |
    cd /home/ubuntu/todoapp
    git fetch --all
    git reset --hard origin/{{ github_branch }}
    git pull origin {{ github_branch }}
  become_user: ubuntu
  when: git_repo.stat.exists
  register: force_git_pull
  ignore_errors: yes
  tags: [deploy]

- name: Show git status after pull
  shell: |
    cd /home/ubuntu/todoapp
    echo "Current commit:"
    git log --oneline -1
    echo "Git status:"
    git status --porcelain
  become_user: ubuntu
  when: git_repo.stat.exists
  register: git_status
  tags: [deploy]

- name: Display git status
  debug:
    var: git_status.stdout_lines
  when: git_repo.stat.exists
  tags: [deploy]

- name: Create .env file from template
  template:
    src: ../../templates/.env.j2
    dest: /home/ubuntu/todoapp/.env
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    force: yes
  register: env_file
  tags: [deploy]

- name: Show .env file contents
  shell: cat /home/ubuntu/todoapp/.env
  register: env_contents
  tags: [deploy]

- name: Display .env file contents
  debug:
    var: env_contents.stdout_lines
  tags: [deploy]

- name: Create letsencrypt directory
  file:
    path: /home/ubuntu/todoapp/letsencrypt
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Check if acme.json exists
  stat:
    path: /home/ubuntu/todoapp/letsencrypt/acme.json
  register: acme_json

- name: Create acme.json if not exists
  file:
    path: /home/ubuntu/todoapp/letsencrypt/acme.json
    state: touch
    owner: ubuntu
    group: ubuntu
    mode: '0600'
  when: not acme_json.stat.exists

- name: Wait for domain to resolve
  shell: |
    echo "Waiting for domain {{ domain }} to resolve to {{ ansible_host }}..."
    for i in {1..60}; do
      RESOLVED_IP=$(dig +short {{ domain }} | tail -n1)
      if [ "$RESOLVED_IP" = "{{ ansible_host }}" ]; then
        echo "Domain resolved correctly!"
        # Verify with multiple DNS servers
        GOOGLE_DNS=$(dig @8.8.8.8 +short {{ domain }} | tail -n1)
        CLOUDFLARE_DNS=$(dig @1.1.1.1 +short {{ domain }} | tail -n1)
        echo "Google DNS: $GOOGLE_DNS, Cloudflare DNS: $CLOUDFLARE_DNS"
        break
      fi
      echo "Attempt $i/60: Domain resolves to $RESOLVED_IP, expected {{ ansible_host }}"
      sleep 15
    done
  ignore_errors: yes
  tags: [deploy]

- name: Update DuckDNS with server IP
  shell: |
    DOMAIN_NAME=$(echo "{{ domain }}" | cut -d'.' -f1)
    echo "Updating DuckDNS for domain: $DOMAIN_NAME with IP: {{ ansible_host }}"
    RESPONSE=$(curl -s "https://www.duckdns.org/update?domains=$DOMAIN_NAME&token={{ duckdns_token }}&ip={{ ansible_host }}")
    echo "DuckDNS response: $RESPONSE"
    if [ "$RESPONSE" = "OK" ]; then
      echo "DuckDNS update successful"
    else
      echo "DuckDNS update failed: $RESPONSE"
    fi
  failed_when: false
  tags: [deploy]

- name: Stop existing containers
  shell: sudo -u ubuntu docker compose down
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes
  tags: [deploy]

- name: Pull latest Docker images
  shell: sudo -u ubuntu docker compose pull
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes
  tags: [deploy]

- name: Create docker network
  shell: |
    docker network inspect app-network >/dev/null 2>&1 || docker network create app-network
  ignore_errors: yes

- name: Build and start Docker Compose services
  shell: sudo -u ubuntu docker compose up -d --build --force-recreate
  args:
    chdir: /home/ubuntu/todoapp
  register: compose_result
  tags: [deploy]

- name: Wait for services to be healthy
  pause:
    seconds: 45

- name: Check running containers
  command: sudo -u ubuntu docker ps
  register: docker_ps
  changed_when: false

- name: Display running containers
  debug:
    var: docker_ps.stdout_lines

- name: Clean old certificates and restart Traefik
  shell: |
    echo "Cleaning old certificates to avoid rate limit issues..."
    sudo -u ubuntu docker compose down traefik
    rm -f /home/ubuntu/todoapp/letsencrypt/acme*.json
    sudo -u ubuntu docker compose up -d traefik
    sleep 45
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes
  tags: [deploy]

- name: Trigger SSL certificate generation if needed
  shell: |
    # Check if SSL certificate exists and is valid
    if ! curl -I https://{{ domain }} --max-time 5 --connect-timeout 3 2>/dev/null | grep -q "HTTP/2 200\|HTTP/1.1 200"; then
      echo "SSL certificate not working, triggering regeneration..."
      sudo -u ubuntu docker exec traefik rm -f /letsencrypt/acme.json
      sudo -u ubuntu docker compose restart traefik
      sleep 60
    else
      echo "SSL certificate is working properly"
    fi
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes

- name: Wait for SSL certificate generation
  shell: |
    echo "Waiting for SSL certificate generation..."
    for i in {1..60}; do
      if curl -I https://{{ domain }} --max-time 10 --connect-timeout 5 2>/dev/null | grep -q "HTTP/"; then
        echo "SSL certificate is working!"
        break
      fi
      echo "Attempt $i/60: Waiting for SSL certificate..."
      sleep 10
    done
  ignore_errors: yes

- name: Check Traefik logs for SSL issues
  shell: |
    echo "Checking Traefik logs for SSL certificate issues..."
    sudo -u ubuntu docker logs traefik --tail 20 | grep -i "acme\|certificate\|error" || echo "No SSL-related logs found"
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes

- name: Final health check
  shell: |
    echo "Final service check..."
    sudo -u ubuntu docker compose ps
    echo "Testing HTTPS connection..."
    curl -I https://{{ domain }} --max-time 10 || echo "HTTPS not ready yet"
    echo "Testing HTTP connection..."
    curl -I http://{{ domain }} --max-time 10 || echo "HTTP not ready yet"
  args:
    chdir: /home/ubuntu/todoapp
  ignore_errors: yes