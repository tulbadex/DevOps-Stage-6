---
- name: Get server public IP
  uri:
    url: http://checkip.amazonaws.com/
    return_content: yes
  register: public_ip_result

- name: Set public IP fact
  set_fact:
    server_public_ip: "{{ public_ip_result.content | trim }}"

- name: Update DuckDNS domain
  uri:
    url: "https://www.duckdns.org/update?domains={{ duckdns_domain }}&token={{ duckdns_token }}&ip={{ server_public_ip }}"
    method: GET
  when: duckdns_domain is defined and duckdns_token is defined

- name: Clone or update repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes
  become_user: ubuntu
  register: git_result

- name: Build Java application
  shell: |
    cd {{ app_dir }}/users-api
    ./mvnw clean package -DskipTests
  become_user: ubuntu
  when: git_result.changed

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Create letsencrypt directory
  become: true
  file:
    path: "{{ app_dir }}/letsencrypt"
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Set correct permissions for acme.json
  become: true
  file:
    path: "{{ app_dir }}/letsencrypt/acme.json"
    state: touch
    mode: '0600'
    owner: ubuntu
    group: ubuntu

- name: Create docker network
  become: true
  shell: |
    docker network inspect app-network >/dev/null 2>&1 || docker network create app-network
  ignore_errors: yes

- name: Stop existing containers
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yml down
  ignore_errors: yes

- name: Check docker-compose file exists
  become: true
  shell: |
    ls -la {{ app_dir }}/
    ls -la {{ app_dir }}/docker-compose*
  register: compose_files
  ignore_errors: yes

- name: Debug compose files
  debug:
    var: compose_files.stdout_lines

- name: Build and start containers
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yml up -d --build
  when: git_result.changed

- name: Start containers (if no changes)
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yml up -d
  when: not git_result.changed

- name: Wait for services to be ready
  wait_for:
    port: 80
    host: localhost
    delay: 30
    timeout: 300