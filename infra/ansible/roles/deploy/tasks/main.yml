---
# Deploy the application

- name: Check if repository exists
  stat:
    path: /home/ubuntu/todoapp/.git
  register: git_repo

- name: Clone repository if not exists
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes
  become_user: ubuntu
  when: not git_repo.stat.exists

- name: Pull latest changes from repository
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes
    update: yes
  become_user: ubuntu
  register: git_pull
  when: git_repo.stat.exists

- name: Create .env file from template
  template:
    src: ../../templates/.env.j2
    dest: /home/ubuntu/todoapp/.env
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  register: env_file

- name: Create letsencrypt directory
  file:
    path: /home/ubuntu/todoapp/letsencrypt
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Check if acme.json exists
  stat:
    path: /home/ubuntu/todoapp/letsencrypt/acme.json
  register: acme_json

- name: Create acme.json if not exists
  file:
    path: /home/ubuntu/todoapp/letsencrypt/acme.json
    state: touch
    owner: ubuntu
    group: ubuntu
    mode: '0600'
  when: not acme_json.stat.exists

- name: Update DuckDNS with server IP
  shell: |
    curl "https://www.duckdns.org/update?domains={{ domain }}&token={{ duckdns_token }}&ip={{ ansible_host }}"
  failed_when: false

- name: Stop existing containers if changes detected
  shell: docker compose down
  args:
    chdir: /home/ubuntu/todoapp
  become_user: ubuntu
  when: git_pull.changed or env_file.changed
  ignore_errors: yes

- name: Pull latest Docker images if changes detected
  shell: docker compose pull
  args:
    chdir: /home/ubuntu/todoapp
  become_user: ubuntu
  when: git_pull.changed or env_file.changed
  ignore_errors: yes

- name: Create docker network
  shell: |
    docker network inspect app-network >/dev/null 2>&1 || docker network create app-network
  ignore_errors: yes

- name: Build and start Docker Compose services
  shell: docker compose up -d --build
  args:
    chdir: /home/ubuntu/todoapp
  become_user: ubuntu
  register: compose_result

- name: Wait for services to be healthy
  pause:
    seconds: 45

- name: Check running containers
  command: docker ps
  become_user: ubuntu
  register: docker_ps
  changed_when: false

- name: Display running containers
  debug:
    var: docker_ps.stdout_lines

- name: Restart containers for SSL and routing stability
  shell: |
    docker compose restart
    sleep 60
  args:
    chdir: /home/ubuntu/todoapp
  become_user: ubuntu
  ignore_errors: yes

- name: Final health check
  shell: |
    echo "Final service check..."
    docker compose ps
    curl -I https://{{ domain }} --max-time 10 --insecure || echo "Domain check completed"
  args:
    chdir: /home/ubuntu/todoapp
  become_user: ubuntu
  ignore_errors: yes