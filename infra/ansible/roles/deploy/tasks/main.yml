---
# Deploy the application

- name: Clone the repository
  become: true
  git:
    repo: "{{ github_repo }}"
    dest: /home/ubuntu/todoapp
    version: "{{ github_branch }}"
    force: yes

- name: Create letsencrypt directory
  become: true
  file:
    path: /home/ubuntu/todoapp/letsencrypt
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Initialize empty acme.json for Let's Encrypt
  become: true
  shell: |
    echo '{}' > /home/ubuntu/todoapp/letsencrypt/acme.json
    chmod 600 /home/ubuntu/todoapp/letsencrypt/acme.json
    chown root:root /home/ubuntu/todoapp/letsencrypt/acme.json

- name: Update DuckDNS with server IP
  become: true
  shell: |
    curl "https://www.duckdns.org/update?domains={{ domain }}&token={{ duckdns_token }}&ip={{ ansible_host }}"
  failed_when: false

- name: Copy environment file
  template:
    src: ../../templates/.env.j2
    dest: "/home/ubuntu/todoapp/.env"
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Create docker network
  become: true
  shell: |
    docker network inspect app-network >/dev/null 2>&1 || docker network create app-network
  args:
    executable: /bin/bash


- name: Start application with Docker Compose
  become: true
  shell: |
    cd /home/ubuntu/todoapp && docker compose up -d
  args:
    executable: /bin/bash

- name: Wait for services to start
  become: true
  shell: |
    echo "Waiting for services to start..."
    sleep 60
    echo "Services should be running now"
  failed_when: false

- name: Verify Traefik routing and SSL
  become: true
  shell: |
    cd /home/ubuntu/todoapp
    
    # Check if all services are healthy
    if ! docker compose ps | grep -q "Up"; then
      echo "Some services not running, restarting..."
      docker compose restart
      sleep 30
    fi
    
    # Wait for SSL certificate generation
    echo "Waiting for SSL certificates..."
    sleep 45
    
    # Verify services
    docker compose ps
    curl -I https://{{ domain }} --max-time 15 --insecure || echo "Domain not ready yet"
  failed_when: false